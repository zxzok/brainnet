{% extends "base.html" %}

{% block title %}Patient Detail - BrainNet MRI Data Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Patient Details</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('edit_patient', patient_id=patient[0]) }}" class="btn btn-secondary me-2">
            <i class="fas fa-edit"></i> Edit
        </a>
        <form method="POST" action="{{ url_for('delete_patient', patient_id=patient[0]) }}" 
              onsubmit="return confirm('Are you sure you want to delete this patient and all associated data?')">
            <button type="submit" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete
            </button>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Patient Information</h5>
                <dl class="row">
                    <dt class="col-sm-3">Patient ID:</dt>
                    <dd class="col-sm-9">{{ patient[1] }}</dd>

                    <dt class="col-sm-3">Name:</dt>
                    <dd class="col-sm-9">{{ patient[2] }}</dd>

                    <dt class="col-sm-3">Age:</dt>
                    <dd class="col-sm-9">{{ patient[3] or 'N/A' }}</dd>

                    <dt class="col-sm-3">Sex:</dt>
                    <dd class="col-sm-9">{{ patient[4] or 'N/A' }}</dd>

                    <dt class="col-sm-3">Diagnosis:</dt>
                    <dd class="col-sm-9">{{ patient[5] or 'N/A' }}</dd>

                    <dt class="col-sm-3">Created At:</dt>
                    <dd class="col-sm-9">{{ patient[6] }}</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">OpenNeuro Datasets</h5>
            </div>
            <div class="card-body">
                {% if openneuro_datasets %}
                <form method="POST" action="{{ url_for('use_openneuro', patient_id=patient[0]) }}" class="row g-2 align-items-center">
                    <div class="col-auto">
                        <select name="dataset_id" class="form-select">
                            {% for ds in openneuro_datasets %}
                            <option value="{{ ds[0] }}">{{ ds[0] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-outline-primary" type="submit">Run Analysis</button>
                    </div>
                </form>
                {% else %}
                <p>No OpenNeuro datasets available. Visit the <a href="{{ url_for('openneuro') }}">OpenNeuro page</a> to download datasets.</p>
                {% endif %}
            </div>
        </div>
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">MRI Images</h5>
                <form method="POST" action="{{ url_for('upload_image', patient_id=patient[0]) }}"
                      enctype="multipart/form-data" class="d-inline">
                    <input type="file" name="image" id="image" class="d-none" required onchange="this.form.submit()">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="document.getElementById('image').click()">
                        <i class="fas fa-upload"></i> Upload Image
                    </button>
                </form>
            </div>
            <div class="card-body">
                {% if images %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Image Type</th>
                                    <th>Description</th>
                                    <th>Acquisition Date</th>
                                    <th>Upload Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for image in images %}
                                    <tr>
                                        <td>{{ image[3] or 'N/A' }}</td>
                                        <td>{{ image[5] or 'No description' }}</td>
                                        <td>{{ image[4] or 'N/A' }}</td>
                                        <td>{{ image[6] }}</td>
                                        <td>
                                            <a href="{{ url_for('view_features', image_id=image[0]) }}" class="btn btn-sm btn-outline-info">
                                                <i class="fas fa-chart-bar"></i> Features
                                            </a>
                                            <form method="POST" action="{{ url_for('delete_image', image_id=image[0]) }}" 
                                                  class="d-inline" 
                                                  onsubmit="return confirm('Are you sure you want to delete this image?')">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p>No MRI images found for this patient.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
